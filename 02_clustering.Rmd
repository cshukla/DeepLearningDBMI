---
title: "Clustering"
author: "Will Townes"
date: "4/30/2018"
output: html_document
---

PCA embeddings

```{r}
library(ggplot2)
ari<-mclust::adjustedRandIndex
fp<-file.path
```

First get the data from the ipython colab. Download the embeddings of cells for each hyperparam setting to embeddings/cortex.

```{r}
clust2ari<-function(X_enc,labels){
  #X_enc has samples in rows and features in cols
  #runs hierarchical clustering and returns adjusted rand score compared to labels
  stopifnot(nrow(X_enc)==length(labels))
  cl<-NbClust::NbClust(d, method="ward.D2", index="ch", min.nc=nlevels(labels), max.nc=nlevels(labels))$Best.partition
  ari(labels,cl)
}

dt<-"cortex"
labels<-read.csv("data/cortex/cell_info.csv")$level1class

dpth<-fp("data",dt,paste0(dt,"_expression.txt"))
Y<-t(as.matrix(read.table(dpth))) #ncells x ngenes
Yl2<-log2(1+Y/rowSums(Y)*1e6)
pca<-prcomp(Yl2,center=TRUE,scale=TRUE)$x

pth<-fp("embeddings",dt)
opth<-fp("results",dt)

model<-c("bernoulli","gaussian","poisson","negative_binomial","pca")
nbshapes<-data.frame(a=c(.1,1,10),astr=c("01","1","10"))
hnodes<-c("200","500")
latent_dims<-c("2","10","50")

#nonlinear except neg binom
res1<-expand.grid(model=model[1:3], latent_dimension=latent_dims, hidden_width=hnodes, nbshape=NA, adj_rand_index=NA)
#nonlinear neg binom
res2<-expand.grid(model="negative_binomial", latent_dimension=latent_dims, hidden_width=hnodes, nbshape=nbshapes$astr, adj_rand_index=NA)
#pca
res3<-expand.grid(model="pca", latent_dimension=latent_dims, hidden_width=NA,nbshape=NA,adj_rand_index=NA)
res<-rbind(res1,res2,res3)
for(i in seq.int(nrow(res))){
  l<-res[i,"model"]; d<-res[i,"latent_dimension"]; h<-res[i,"hidden_width"]
  if(l=="negative_binomial"){
    a<-res[i,"nbshape"]
    fname<-paste0(l,a,"_d",d,"_h",h)
  } else if(l!="pca"){
    fname<-paste0(l,"_d",d,"_h",h)
  }
  if(l!="pca"){
    d<-read.table(fp(pth,paste0(fname,".txt")))
  } else {
    d<-pca[,seq.int(as.integer(d))]
  }
  res[i,"adj_rand_index"]<-clust2ari(d,labels)
}
res$nbshape[res$nbshape=="01"]<-"0.1"
res$dataset<-dt
dir.create(opth,recursive=TRUE)
write.csv(res,fp(opth,"ari.csv"))
```

```{r}
res<-read.csv("results/cortex/ari.csv")
ggplot(res,aes(x=model,y=adj_rand_index,fill=model))+geom_boxplot()+theme_bw()

ggplot(res,aes(x=latent_dimension,y=adj_rand_index,fill=model))+geom_boxplot()+theme_bw()

dir.create("results/plots",recursive=TRUE)
ggsave("results/plots/cortex_ari.pdf",width=6,height=4)
```
